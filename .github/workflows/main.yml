name: Deploy nails-bot

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Upload or update code on remote server
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          PAT: ${{ secrets.PAT }}
        run: |
          sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$HOST '
            if [ -d /var/www/nails-bot/github/frontend/.git ]; then
              echo "üì¶ Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞–π–¥–µ–Ω ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ–º pull"
              cd /var/www/nails-bot/github/frontend && \
              git remote set-url origin https://'"$USERNAME:$PAT"'@github.com/NIL-IT/nails-bot.git && \
              git pull origin main || echo "‚ö†Ô∏è Git pull –Ω–µ —É–¥–∞–ª—Å—è"
            else
              echo "üÜï Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –∫–æ–ø–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç —á–µ—Ä–µ–∑ SCP"
              mkdir -p /var/www/nails-bot/github/frontend
            fi
          '

          # –ï—Å–ª–∏ .git –Ω–µ—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ SCP
          sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$HOST '! [ -d /var/www/nails-bot/github/frontend/.git ]' && \
          sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no -r ./ $USERNAME@$HOST:/var/www/nails-bot/github/frontend/

      - name: Build project using npm (only if index.html exists)
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$HOST '
            cd /var/www/nails-bot/github/frontend &&
            if [ -f index.html ]; then
              echo "üõ†Ô∏è index.html –Ω–∞–π–¥–µ–Ω ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É"
              npm install && npm run build
            else
              echo "‚ö†Ô∏è index.html –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞"
            fi
          '

      - name: Copy built files to production directory
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$HOST "
            if [ -d /var/www/nails-bot/github/frontend/dist ]; then
              rm -rf /var/www/nails-bot/frontend/* && \
              cp -r /var/www/nails-bot/github/frontend/dist/* /var/www/nails-bot/frontend/
            else
              echo '‚ö†Ô∏è –ü–∞–ø–∫–∞ dist –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Ñ–∞–π–ª—ã –Ω–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã.'
            fi
          "
