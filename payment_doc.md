
# üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ñ–∞–π–ª—É `https://nails.nilit2.ru:8000/payment.php`

## üìå –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π **Tinkoff**. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–ª–∞—Ç–µ–∂–∞ (`init_payment`);
- –ü—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ (`verify_payment`);
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –ø–ª–∞—Ç–µ–∂–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL.

---

## üì§ –§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞

### Content-Type:
- `application/json` (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ)
- `application/x-www-form-urlencoded` (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ:
- `type` ‚Äî —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏: `init_payment` –∏–ª–∏ `verify_payment`  
  (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `init_payment`)

### –ü—Ä–∏–º–µ—Ä:
- `type`:"verify_payment"
- `payment_id`: 6258013419
---
- "type": "init_payment",
- "amont": 100,               --- (1 —Ä—É–±–ª—å)
- "id_tg_user": 665111465,
- "order_id": 123
---

## üîÅ –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏: `init_payment`

### üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞

| –ü–æ–ª–µ         | –¢–∏–ø     | –û–±—è–∑–∞—Ç–µ–ª–µ–Ω | –û–ø–∏—Å–∞–Ω–∏–µ                           |
|--------------|----------|------------|------------------------------------|
| `type`       | string   | ‚úÖ          | –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ–º `init_payment` |
| `amont`      | integer  | ‚úÖ          | –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö *(–æ–ø–µ—á–∞—Ç–∫–∞, –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `amount`)* |
| `id_tg_user` | integer  | ‚úÖ          | Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è           |
| `order_id`   | integer  | ‚úÖ          | ID –∑–∞–∫–∞–∑–∞                          |

### üì• –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
- –§–æ—Ä–º–∏—Ä—É–µ—Ç `OrderId` –≤–∏–¥–∞: `{order_id}_{tg_user_id}_{timestamp}`;
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `Token` –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É Tinkoff;
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ `https://securepay.tinkoff.ru/v2/Init`;
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–ª–∞—Ç—ë–∂–Ω—É—é —Å—Å—ã–ª–∫—É –∏ ID –ø–ª–∞—Ç–µ–∂–∞.

### ‚úÖ –ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

```json
{
  "status": "ok",
  "payment_url": "https://securepay.tinkoff.ru/v2/Payment/...",
  "order_id": "123_42_1713978743",
  "payment_id": "1234567890",
  "response": { ... } // –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç Tinkoff
}
```

---

## üîÅ –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏: `verify_payment`

### üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞

| –ü–æ–ª–µ         | –¢–∏–ø    | –û–±—è–∑–∞—Ç–µ–ª–µ–Ω | –û–ø–∏—Å–∞–Ω–∏–µ                         |
|--------------|--------|------------|----------------------------------|
| `type`       | string | ‚úÖ          | –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ–º `verify_payment` |
| `payment_id` | string | ‚úÖ          | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–ª–∞—Ç–µ–∂–∞ Tinkoff    |

### üì• –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ `https://securepay.tinkoff.ru/v2/GetState`;
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞;
- –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω (`CONFIRMED`), –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–µ `payment_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `orders` –≤ PostgreSQL;
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ.

### ‚úÖ –ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

```json
{
  "status": "ok",
  "message": "–ü–ª–∞—Ç—ë–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω",
  "amount": 900,
  "order_id": 123,
  "tg_user_id": 42,
  "payment_id": "1234567890",
  "tinkoff_response": { ... }
}
```

### ‚ùå –ü—Ä–∏–º–µ—Ä—ã –æ—à–∏–±–æ–∫

| HTTP-–∫–æ–¥ | –°–æ–æ–±—â–µ–Ω–∏–µ                         | –ü—Ä–∏—á–∏–Ω–∞                               |
|----------|----------------------------------|----------------------------------------|
| 400      | `–ù–µ –ø–µ—Ä–µ–¥–∞–Ω payment_id`          | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä     |
| 400      | `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏`       | –ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `type`              |
| 500      | `–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç—ë–∂` | –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ —Å–µ—Ç–µ–≤–æ–π —Å–±–æ–π |
| 200      | `–ü–ª–∞—Ç—ë–∂ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω`          | –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç `CONFIRMED` |

---

## üîê –ê–ª–≥–æ—Ä–∏—Ç–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `Token`

–¢–æ–∫–µ–Ω —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º Tinkoff:

1. –£–¥–∞–ª—è—é—Ç—Å—è –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø–æ–ª—è `DATA`, `Receipt`;
2. –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è `Password`;
3. –ú–∞—Å—Å–∏–≤ —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ –∫–ª—é—á–∞–º (`ksort`);
4. –°–∫–ª–µ–∏–≤–∞—é—Ç—Å—è –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–¥—Ä—è–¥;
5. –°—Ç—Ä–æ–∫–∞ —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `SHA-256`.

---

## üõ† –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- `DatabaseClient.php` ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL;
- `cors.php` ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è CORS;
- `file_get_contents()` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API Tinkoff.

---

## ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–ø–µ—á–∞—Ç–∫—É `amont` –Ω–∞ `amount`;
- –•—Ä–∞–Ω–∏—Ç—å `TerminalKey` –∏ `Password` –≤ `.env`-—Ñ–∞–π–ª–µ –∏–ª–∏ –¥—Ä—É–≥–æ–º –∑–∞—â–∏—â—ë–Ω–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ;
- –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —Ñ–∞–π–ª –∏–ª–∏ Sentry);
- –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–∏–ø–æ–≤ –∑–Ω–∞—á–µ–Ω–∏–π (`is_numeric`, `is_string` –∏ —Ç.–ø.).

---
