name: Deploy nails-bot

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Upload or update code on remote server
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          PAT: ${{ secrets.PAT }}
        run: |
          sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$HOST '
            if [ "$(ls -A /var/www/nails-bot/github/frontend 2>/dev/null)" ]; then
              echo "üì¶ –ü–∞–ø–∫–∞ –Ω–µ –ø—É—Å—Ç–∞ ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ–º git pull"
              cd /var/www/nails-bot/github/frontend && \
              git pull origin main || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å git pull"
            else
              echo "üÜï –ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞ ‚Äî –∫–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç"
            fi
          '

          sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$HOST '
            if [ ! "$(ls -A /var/www/nails-bot/github/frontend 2>/dev/null)" ]; then
              mkdir -p /var/www/nails-bot/github/frontend
            fi
          '

          sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$HOST '
            if [ ! "$(ls -A /var/www/nails-bot/github/frontend 2>/dev/null)" ]; then
              echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ SCP"
            fi
          '

          if sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$HOST '! [ "$(ls -A /var/www/nails-bot/github/frontend 2>/dev/null)" ]'; then
            sshpass -p "$PASSWORD" scp -o StrictHostKeyChecking=no -r ./ $USERNAME@$HOST:/var/www/nails-bot/github/frontend/
          fi

      - name: Build project using npm (only if index.html exists)
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$HOST '
            cd /var/www/nails-bot/github/frontend &&
            if [ -f index.html ]; then
              echo "üõ†Ô∏è index.html –Ω–∞–π–¥–µ–Ω ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É"
              npm install && npm run build
            else
              echo "‚ö†Ô∏è index.html –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞"
            fi
          '

      - name: Copy built files to production directory
        env:
          HOST: ${{ secrets.HOST }}
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no $USERNAME@$HOST "
            if [ -d /var/www/nails-bot/github/frontend/dist ]; then
              rm -rf /var/www/nails-bot/frontend/* && \
              cp -r /var/www/nails-bot/github/frontend/dist/* /var/www/nails-bot/frontend/
            else
              echo '‚ö†Ô∏è –ü–∞–ø–∫–∞ dist –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Ñ–∞–π–ª—ã –Ω–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã.'
            fi
          "
